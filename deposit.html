<!doctype html>
<html>
<head>
    <title>Deposit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<h1>Deposit</h1>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul>
      {% for message in messages %}
      <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<form method="POST" id="deposit-form">
    Amount: 
    <input type="number" step="0.01" name="amount" required><br><br>
    <button type="submit">Generate QR</button>
</form>

<div id="qr-container">
{% if qr %}
    <h2>Scan this QR to pay:</h2>
    <img id="qr-image" src="data:image/png;base64,{{ qr }}" style="width:250px;">
    
    <div id="payment-status" style="margin-top:15px;font-size:20px;color:green;">
        Waiting for payment...
    </div>

    <div id="timer" style="font-size:18px;margin-top:10px;color:red;">
        ‚è≥ Time left: <span id="time-left">180</span> seconds
    </div>

    <script>
        const userId = "{{ session.get('user_id') }}";
        let timeLeft = 180; // 3 minutes countdown

        if (userId) {

            // ‚è≥ Countdown Timer
            const countdown = setInterval(() => {
                timeLeft--;
                $("#time-left").text(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    clearInterval(paymentLoop);

                    $("#qr-image").remove();
                    $("#payment-status").html("‚ùå Time is out, QR expired.");
                }
            }, 1000);

            // üîÅ Payment Check Loop
            const paymentLoop = setInterval(() => {
                $.get("/check_payment_status/" + userId, function(data) {
                    if (data.paid === true) {
                        clearInterval(paymentLoop);
                        clearInterval(countdown);

                        $("#qr-image").remove();
                        $("#payment-status").html("‚úÖ Thank you for your deposit!");
                        $("#timer").hide();
                    }
                });
            }, 5000);
        }
    </script>

{% endif %}
</div>

<br>
<a href="{{ url_for('home') }}">Back</a>

</body>
</html>
